<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>DMC5 - DANTE & VERGIL SIGMA</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: monospace; }
        
        /* UI LOADING */
        #console-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); color: #0f0; 
            padding: 20px; box-sizing: border-box; overflow-y: auto; z-index: 9999;
            display: flex; flex-direction: column;
        }
        #console-text { flex: 1; white-space: pre-wrap; font-size: 14px; }
        #start-area { text-align: center; padding: 20px; display: none; border-top: 1px solid #333; }
        
        .btn { 
            padding: 15px 40px; font-size: 1.5rem; cursor: pointer; 
            border: 2px solid #0f0; background: #000; color: #0f0; 
            text-transform: uppercase; font-weight: bold; margin: 10px;
            transition: 0.3s;
        }
        .btn:hover { background: #0f0; color: #000; }

        /* UI IN-GAME */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; }
        #debug-timer { position: absolute; top: 20px; right: 20px; color: yellow; font-size: 1.5rem; text-shadow: 2px 2px 0 #000; }
        #back-btn { position: absolute; top: 20px; left: 20px; padding: 10px 20px; background: red; color: white; border: none; cursor: pointer; pointer-events: auto; font-weight: bold; }
    </style>
</head>
<body>

    <div id="console-overlay">
        <h1>SYSTEM STATUS:</h1>
        <div id="console-text">Initializing...</div>
        <div id="start-area">
            <h2 style="color:white;">ASSETS READY</h2>
            <button class="btn" onclick="startGame('cinematic')">PLAY TRAILER</button>
            <button class="btn" onclick="startGame('freecam')">FREE CAMERA</button>
        </div>
    </div>

    <div id="ui-layer">
        <button id="back-btn" onclick="location.reload()">RESTART</button>
        <div id="debug-timer">TIME: 0.00s</div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- VARS ---
        let scene, camera, renderer, clock;
        let danteModel, vergilModel;
        let mixers = []; 
        let danteMixer, vergilMixer;
        
        // Actions
        let danteActions = {}, activeDanteAction;
        let vergilActions = {}, activeVergilAction;

        let time = 0, mode = 'menu';
        let video, videoMesh, sound;
        const keys = { shift: false, w: false, a: false, s: false, d: false, q: false, e: false }; 

        // --- LOGGER ---
        function log(msg, type='info') {
            const el = document.getElementById('console-text');
            const color = type === 'error' ? 'red' : (type === 'warn' ? 'orange' : '#0f0');
            console.log(msg);
            el.innerHTML += `<span style="color:${color}">> ${msg}</span><br>`;
            el.scrollTop = el.scrollHeight; 
        }

        // --- INPUT HANDLING ---
       window.addEventListener('keydown', (e) => {
            const key = e.key.toLowerCase();
            if (keys.hasOwnProperty(key)) keys[key] = true;
            if (e.key === 'Shift') keys.shift = true;

            // Fitur Timeskip Adegan (Angka 1-9 dan 0)
            if (mode === 'cinematic') {
                const skipMap = {
                    '1': 0, '2': 8.5, '3': 12.2, '4': 13.2, '5': 17.0,
                    '6': 24.0, '7': 29.0, '8': 34.5, '9': 38.5, '0': 42.0,
                    '-': 45.0, 
                    '=': 48.0,   // Adegan 12: Orbit Rotate
                    '[': 53.0,   // Adegan 13: Dante Close-up Final
                    ']': 56.0    // Adegan 14: Vergil Close-up Final
                };

                if (skipMap[e.key] !== undefined) {
                    time = skipMap[e.key];
                    
                    if(vergilModel) {
                        // Konsistensi posisi Vergil di Z=42 untuk adegan 5 ke atas
                        if (time >= 21.5) {
                            vergilModel.position.z = 42; 
                            vergilModel.rotation.y = (time >= 24) ? Math.PI : 0;
                        } else {
                            vergilModel.position.z = 40.0;
                            vergilModel.rotation.y = 0;
                        }
                    }
                    log(`Jump to Scene ${e.key} (Time: ${time}s)`);
                }
            }
        });
        window.addEventListener('keyup', (e) => {
            const key = e.key.toLowerCase();
            if (keys.hasOwnProperty(key)) keys[key] = false;
            if (e.key === 'Shift') keys.shift = false;
        });

        

        function init() {
            log("Memulai Three.js...");
            
            try {
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x87CEEB);
                scene.fog = new THREE.Fog(0x87CEEB, 20, 150);

                camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.01, 1000);
                
                renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true }); 
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                document.body.appendChild(renderer.domElement);

                // Lighting
                const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 1.2); scene.add(hemi);
                const dir = new THREE.DirectionalLight(0xffffff, 1.5);
                dir.position.set(10, 20, 10); dir.castShadow = true; scene.add(dir);

                // Audio Video
                const listener = new THREE.AudioListener(); camera.add(listener);
                sound = new THREE.Audio(listener);
                new THREE.AudioLoader().load('assets/sounds/sound.mp3', b => { 
                    sound.setBuffer(b); sound.setVolume(0.5); 
                    log("Audio Loaded");
                }, undefined, () => log("Audio Gagal Load (Gpp)", 'warn'));

                video = document.createElement('video'); video.src = 'assets/video/clock.mp4'; video.load(); video.muted = true;
                videoMesh = new THREE.Mesh(new THREE.PlaneGeometry(16, 9), new THREE.MeshBasicMaterial({ map: new THREE.VideoTexture(video), side: 2 }));
                videoMesh.visible = false; scene.add(videoMesh);

                clock = new THREE.Clock();
                
                log("Scene Initialized. Loading Assets...");
                loadAssets();

            } catch (e) {
                log("CRITICAL ERROR: " + e.message, 'error');
            }

            // Events
            window.addEventListener('resize', () => { camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
            window.startGame = (m) => {
                mode = m; time = 0;
                document.getElementById('console-overlay').style.display = 'none';
                document.getElementById('ui-layer').style.display = 'block';
                video.muted = false;
                
                if(danteModel) {
                    danteModel.position.set(-20, 0, 15);
                    playDanteAnim('Stand');
                }
                if(vergilModel) {
                    // Mulai dari posisi duduk yang pas di kursi
                    vergilModel.position.set(-20, 0, 40.0);
                    vergilModel.rotation.set(0, 0, 0);
                    playVergilAnim('Sit', 0);
                }

                
                if(m === 'freecam') { camera.position.set(0, 10, 50); camera.lookAt(0,0,0); }
                animate();
            };
        }

        // --- CLEANERS ---
        function sanitizeBoneName(name) { return name.replace('mixamorig', '').replace(':', ''); }
        
        function sanitizeModel(model) {
            model.traverse((child) => {
                if (child.isBone) child.name = sanitizeBoneName(child.name);
            });
        }

        function sanitizeClip(clip) {
            const safeTracks = [];
            clip.tracks.forEach((track) => {
                const parts = track.name.split('.');
                const boneName = sanitizeBoneName(parts[0]);
                const prop = parts[1];
                if (clip.name.toLowerCase().includes('stand') && prop === 'position') return; 
                track.name = boneName + '.' + prop;
                safeTracks.push(track);
            });
            clip.tracks = safeTracks;
            return clip;
        }

        // --- LOAD ASSETS ---
        function loadAssets() {
            const loader = new GLTFLoader();
            const data = {};
            const assets = [
                { id: 'walk', path: 'assets/animations/dante_walking.glb' },
                { id: 'stand', path: 'assets/animations/dante_standing.glb' },
                { id: 'vergil_stand', path: 'assets/animations/vergil_standing.glb' }, 
                { id: 'vergil_sit', path: 'assets/animations/vergil_sit.glb' },
                { id: 'chair', path: 'assets/models/plastic_chair.glb' },
                { id: 'map', path: 'assets/models/walmart.glb' },
                { id: 'yamato', path: 'assets/models/vergils_sword.glb' },
                { id: 'rebellion', path: 'assets/models/dantes_sword.glb' }
            ];

            let count = 0;
            assets.forEach(a => {
                loader.load(a.path, (gltf) => {
                    data[a.id] = gltf;
                    log(`Loaded: ${a.id}`);
                    count++;
                    if(count === assets.length) setupScene(data);
                }, undefined, (e) => {
                    log(`GAGAL LOAD: ${a.path} (${e.message})`, 'error');
                    count++;
                    if(count === assets.length) setupScene(data);
                });
            });
        }

        function setupScene(data) {
            log("Setting up Scene...");

            if(data.map) { const m=data.map.scene; m.rotation.y=-Math.PI/2; scene.add(m); }
            if(data.chair) { const c=data.chair.scene; c.position.set(-20,0,40); c.scale.set(2,2,2); scene.add(c); }
            if(data.yamato) { const y=data.yamato.scene; y.position.set(30,3,35); y.scale.set(5,5,5); scene.add(y); }
            if(data.rebellion) { const r=data.rebellion.scene; r.name='rebellion'; r.position.set(33,1,40); r.scale.set(1.5,1.5,1.5); scene.add(r); }

            // === DANTE ===
            if(data.walk) {
                danteModel = data.walk.scene;
                sanitizeModel(danteModel);
                danteModel.position.set(-20, 0, 15);
                danteModel.scale.set(2, 2, 2);
                
                danteModel.traverse(o => { 
                    if(o.isMesh) { o.castShadow = true; o.receiveShadow = true; o.frustumCulled = false; } 
                });
                scene.add(danteModel);

                danteMixer = new THREE.AnimationMixer(danteModel);
                mixers.push(danteMixer);

                if(data.walk.animations.length > 0) danteActions['Walk'] = danteMixer.clipAction(sanitizeClip(data.walk.animations[0]));
                if(data.stand && data.stand.animations.length > 0) danteActions['Stand'] = danteMixer.clipAction(sanitizeClip(data.stand.animations[0]));
                if(danteActions['Stand']) playDanteAnim('Stand');
            }

            // === VERGIL (FIX VISUAL & POSISI) ===
            if(data.vergil_stand) {
                log("Configuring Vergil...");
                vergilModel = data.vergil_stand.scene; 
                sanitizeModel(vergilModel);
                
                // FIX POSISI: Sedikit maju dari kursi (Z = 40.8)
                vergilModel.position.set(-20, 0, 40.8);
                vergilModel.scale.set(0.2, 0.2, 0.2); 
                
                vergilModel.traverse(o => { 
                    if(o.isMesh) { 
                        o.castShadow = true; 
                        o.receiveShadow = true; 
                        o.frustumCulled = false;
                        
                        // === FIX MATERIAL WAJAH & RAMBUT ===
                        if(o.material) {
                            o.material.depthWrite = true;       // Paksa tulis depth agar tidak tembus
                            o.material.transparent = false;     // Matikan transparent murni
                            o.material.alphaTest = 0.5;         // Gunakan alpha cut untuk rambut
                            o.material.side = THREE.DoubleSide; // Render dua sisi
                        }
                    } 
                });
                scene.add(vergilModel);

                vergilMixer = new THREE.AnimationMixer(vergilModel);
                mixers.push(vergilMixer);

                if(data.vergil_stand.animations.length > 0) vergilActions['Stand'] = vergilMixer.clipAction(sanitizeClip(data.vergil_stand.animations[0]));
                
                if(data.vergil_sit && data.vergil_sit.animations.length > 0) {
                    const clip = sanitizeClip(data.vergil_sit.animations[0]);
                    vergilActions['Sit'] = vergilMixer.clipAction(clip);
                    vergilActions['Sit'].setLoop(THREE.LoopOnce); 
                    vergilActions['Sit'].clampWhenFinished = true;
                }
                playVergilAnim('Sit', 0);

            } else {
                log("CRITICAL: vergil_standing.glb tidak ditemukan!", 'error');
            }

            log("READY TO PLAY!");
            document.getElementById('start-area').style.display = 'block';
        }

        // Helper Animations
        function playDanteAnim(name) {
            if(!danteActions[name]) return;
            const next = danteActions[name];
            if(activeDanteAction === next) return;
            if(activeDanteAction) activeDanteAction.fadeOut(0.5);
            next.reset().fadeIn(0.5).play();
            activeDanteAction = next;
        }

        // Helper Vergil
        function playVergilAnim(name, fadeDuration = 1.0) {
            if(!vergilActions[name]) return;
            const next = vergilActions[name];
            if(activeVergilAction === next) return;
            
            if(activeVergilAction) activeVergilAction.fadeOut(fadeDuration);
            next.reset().fadeIn(fadeDuration).play();
            activeVergilAction = next;
        }

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            mixers.forEach(m => m.update(delta));

            if(mode === 'cinematic') {
                time += delta;
                document.getElementById('debug-timer').innerText = "TIME: " + time.toFixed(2);
                if(time>2 && !sound.isPlaying && sound.buffer) sound.play();

                // adegan 1(0-8.5s)
                if(time < 8.5) {
                    playDanteAnim('Walk');
                    if(danteModel) {
                        if(time<4) danteModel.position.z += delta * 1.5;
                        else if(time>=5.5) danteModel.position.z += delta * 1.0;
                        camera.position.set(-20, 3.5, 32-(time*0.4)); camera.lookAt(-20, 3, danteModel.position.z);
                    }
                } 
                // adegan 2 (8.5-17s)
                else if(time < 12.2) {
                    playDanteAnim('Stand');
                    videoMesh.visible=true; videoMesh.position.set(-20,5,25);
                    camera.position.set(-20,5,31); camera.lookAt(-20,5,25);
                    if(video.paused) video.play();
                } 
                // adegan 3 (12.2-13.2s)
                else if(time < 13.2) {
                    playDanteAnim('Walk');
                    videoMesh.visible=false; video.pause();
                    if(danteModel) {
                        danteModel.position.z += delta * 3.0;
                        camera.position.set(-18.5, 2.5, danteModel.position.z - 5); camera.lookAt(-20, 1.5, 40);
                    }
                } 
                // adegan 4 (13.2-17s)
                else if(time < 17.0) {
                    playDanteAnim('Stand'); if(danteModel) danteModel.position.z=33;
                    const zoomTime = time - 13.2;
                    camera.position.set(-20, 1.8, 34 + (zoomTime * 0.4));
                    camera.lookAt(-20, 1.2, 40);
                }
                // adegan 5 (17-24s)
                else if(time < 24.0) {
                    const t = time - 17.0;
                    const speed = -(t * 0.1) + (Math.PI * 0.4);
                    camera.position.set(-20 + Math.sin(speed)*3.5, 3.5, 40 + Math.cos(speed)*3.5);
                    camera.lookAt(-20, 3, 40);

                    if (time > 21.5) { 
                        // POSISI BERDIRI: Maju lebih jauh ke 41.5 agar jubah/kaki aman
                        if(vergilModel) vergilModel.position.z = 41; 
                        playVergilAnim('Stand', 0.4); 
                    } else {
                        // POSISI DUDUK: Tetap di 40.0 (pas di kursi)
                        if(vergilModel) vergilModel.position.z = 40.0;
                        playVergilAnim('Sit', 0.5);
                    }
                }
                // adegan 6 (24-29s)
                else if(time < 29.0) {
                    // Vergil tetap di posisi maju saat berputar
                    if(vergilModel) vergilModel.position.z = 42;
                    
                    playVergilAnim('Stand', 0.2);
                    if(vergilModel && vergilModel.rotation.y < Math.PI) vergilModel.rotation.y += delta * 1.8;
                    
                    const t = time - 24.0;
                    camera.position.set(-20, 3.5, 40 - Math.max(3.0, 5.0 - t*0.2));
                    camera.lookAt(-20, 3, 40);
                }
                // adegan 7 (29-34.5s)
                else if(time < 34.5) {
                    const reb = scene.getObjectByName('rebellion');
                    
                    // Pastikan Vergil tetap di posisi Z=42 agar tidak tabrak kursi
                    if(vergilModel) vergilModel.position.z = 42;

                    if(time < 33.0) {
                        // --- FASE 1: ZOOM KE DANTE (29s - 33s) ---
                        if(reb) reb.visible = false;
                        
                        const zoomProgress = (time - 29.0) * 0.6;
                        camera.position.set(-20, 3.5, 38 - zoomProgress); 
                        camera.lookAt(-20, 3.0, 33);
                    } 
                    else {
                        // --- FASE 2: PEDANG MUNCUL & TILT ARAH PANDANG (33s - 34.5s) ---
                        if(reb) { 
                            reb.visible = true; 
                            reb.position.set(-20.5, 5.4, 33.05); 
                            reb.rotation.set(-0.15, 0, Math.PI); 
                        }

                        // POSISI TETAP: Mengunci posisi terakhir dari fase zoom (sekitar Z = 35.6)
                        camera.position.set(-20, 3.5, 35.6);

                        // TILT: Hanya mengubah arah pandang (lookAt) secara perlahan ke koordinat pedang
                        const tiltProgress = (time - 33.0) * 0.8; 
                        camera.lookAt(
                            -20 - tiltProgress, // Bergeser ke arah pedang (kiri dari sudut pandang Dante)
                            3.0 - (tiltProgress * 0.2), // Sedikit menunduk ke arah gagang pedang
                            33
                        );
                    }
                }
                // adegan 8 (34.5-38.5s)
                else if(time < 38.5) {
                    if(vergilModel) vergilModel.rotation.y = Math.PI;
                    camera.position.set(-21 + (Math.random()-0.5)*0.01, 3.5 + (Math.random()-0.5)*0.01, 38.5);
                    camera.lookAt(-20, 3, 40);
                }
                // adgean 9 (38.5-42s)
                else if(time < 42.0) {
                    camera.position.set(-20.5 + (Math.random()-0.5)*0.01, 3.5 + (Math.random()-0.5)*0.01, 34.8);
                    camera.lookAt(-20, 3, 33);
                }

                // === LOGIKA BARU SESUAI REQUEST ===
                
                // adegan 10 (42-45s) - Close up Dante
                else if (time < 45.0) {
                    playDanteAnim('Stand');
                    // Menaikkan Y dari 1.75 ke 2.2 agar sejajar kepala Dante
                    camera.position.set(-20.5, 3.5, 33.2);
                    camera.lookAt(-20, 3.5, 33.3);
                }
                // adegan 11 (45-48s) - Close up Vergil (Sisi Kiri)
                else if (time < 48.0) {
                    // Posisi kamera diatur ke X: -21.5 (Sisi kiri Vergil)
                    // Ketinggian Y: 3.5 sesuai dengan settingan pas Anda di adegan 10
                    // Posisi Z: 40.5 agar berada sedikit di depan Vergil (Z: 42)
                    camera.position.set(-20.5, 3.45, 41.7);
                    
                    // Kamera menatap ke arah kepala Vergil
                    camera.lookAt(-20, 3.45, 41.8);
                }
                // adegan 12 (48-53s) - Orbit Shot Belakang Kanan (Dante Diam)
                else if (time < 53.0) {
                    // Pivot tetap di tengah antara Dante (~Z:33) dan Vergil (Z:42)
                    const pivotZ = 37.5; 
                    const pivotX = -20;
                    const radius = 7.0; 
                    
                    // Rotasi orbit sangat pelan
                    const t = (time - 48.0) * 0.12; 
                    const angle = t + (Math.PI * 1.1); // Mulai dari belakang kanan Dante

                    camera.position.set(
                        pivotX + Math.sin(angle) * radius,
                        3.5, 
                        pivotZ + Math.cos(angle) * radius
                    );

                    camera.lookAt(pivotX, 2.8, pivotZ);

                    // --- PERBAIKAN: DANTE TETAP DIAM ---
                    playDanteAnim('Stand'); 
                    // Tidak ada danteModel.position.z += delta
                }
                // adegan 13 (53-56s) - Low Angle Dante & Tilt Samping ke Pedang
                else if (time < 56.0) {
                    const reb = scene.getObjectByName('rebellion');
                    // Mengambil posisi Z Dante secara dinamis agar kamera tetap presisi
                    const danteZ = danteModel ? danteModel.position.z : 33;
                    
                    if (time < 54.0) {
                        // --- FASE 1: DANTE JALAN MAJU (53-54s) ---
                        playDanteAnim('Walk');
                        if (danteModel) danteModel.position.z += delta * 1.5; 
                        
                        // Kamera Low Angle jarak dekat, ikut mundur sedikit sesuai pergerakan Dante
                        // X: -20 (tengah), Y: 1.5 (bawah), Z: danteZ + 3.0 (dekat di depan)
                        camera.position.set(-20, 1.5, danteZ + 3.0); 
                        camera.lookAt(-20, 3.2, danteZ); // Fokus awal ke arah dada/wajah
                    } 
                    else {
                        // --- FASE 2: DANTE DIAM & TILT KE KIRI (54-56s) ---
                        playDanteAnim('Stand');
                        
                        // Posisi kamera diam di tempat (Lock)
                        camera.position.set(-20, 2, danteZ + 3.0);
                        
                        // TILT KE KIRI: Mengubah target pandangan ke arah koordinat pedang di kiri
                        const tiltProgress = (time - 54.0) * 1; 
                        camera.lookAt(
                            -20 - tiltProgress, // Target bergeser ke arah kiri (X negatif)
                            3.2 - (tiltProgress * 0.2), // Sedikit turun tapi tetap fokus pada tinggi pedang
                            danteZ
                        );
                        
                        if(reb) reb.visible = true;
                    }
                }
                // adegan 14 (56-59s) - Vergil Close-up & Vertical Tilt
                else {
                    const vergilZ = vergilModel ? vergilModel.position.z : 42;
                    
                    // Pastikan Vergil tetap pada posisi berdiri dan menghadap Dante
                    playVergilAnim('Stand', 0.2);
                    if(vergilModel) {
                        vergilModel.position.z = 42;
                        vergilModel.rotation.y = Math.PI;
                    }

                    // POSISI KAMERA: Tetap di level kepala (3.45) agar shot konsisten
                    // Z: vergilZ - 1.2 (Sangat dekat di depan wajah)
                    camera.position.set(-20, 3.45, vergilZ - 1.2);

                    if (time < 57.0) {
                        // --- FASE 1: VERTICAL TILT (56-57s) ---
                        const tiltProgress = (time - 56.0); // 0 sampai 1
                        
                        camera.lookAt(
                            -20, 
                            // KITA NAIKKAN AWALNYA: dari 2.0 (pinggang/dada) ke 3.45 (kepala)
                            // Sebelumnya 1.0 (terlalu bawah/kaki)
                            2.0 + (tiltProgress * 1.45), 
                            vergilZ
                        );
                    } 
                    else {
                        // --- FASE 2: LOCK ON FACE (57-59s) ---
                        camera.lookAt(-20, 3.45, vergilZ);
                    }
                }

            } else if (mode === 'freecam') {
                const spd = (keys.shift ? 24 : 8) * delta;
                if(camera) {
                    if(keys.w) camera.translateZ(-spd); if(keys.s) camera.translateZ(spd);
                    if(keys.a) camera.translateX(-spd); if(keys.d) camera.translateX(spd);
                    if(keys.q) camera.position.y += spd; if(keys.e) camera.position.y -= spd;
                }
            }
            renderer.render(scene, camera);
        }

        init();
    </script>
</body>
</html>